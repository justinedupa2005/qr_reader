<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../static/css/style.css" />
    <link rel="stylesheet" href="../static/css/qr_reader.css" />
  </head>
  <body>
    <!-- Header -->
    <header
      class="w-full h-[10vh] min-h-[60px] flex justify-center items-center bg-blue-600 px-4 fixed top-0 left-0 z-50"
    >
      <div class="flex-1">
        <p class="text-white text-sm sm:text-base md:text-lg">
          Python (19877) 8:00-10:30 MW
        </p>
      </div>

      <div class="flex-1 flex justify-end">
        <a
          href="/sign-in"
          class="text-white text-sm sm:text-base md:text-lg hover:underline"
          >Login</a
        >
      </div>
    </header>

    <!-- Student Info Popup -->
    <div
      id="studentPopup"
      class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-md bg-white rounded-lg shadow-2xl border-4 border-blue-500 p-6 z-50 opacity-0 hidden"
    >
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-blue-800">Student Information</h3>
        <button
          id="closePopup"
          class="text-gray-500 hover:text-gray-700 text-2xl font-bold"
        >
          Ã—
        </button>
      </div>

      <!-- Student Photo -->
      <div class="flex justify-center mb-4">
        <div
          class="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden"
        >
          <img
            id="popupImage"
            src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png"
            alt="student"
            class="w-full h-full object-cover"
          />
        </div>
      </div>

      <div class="space-y-3">
        <div class="bg-blue-50 p-3 rounded-lg">
          <p class="text-xs text-gray-600 mb-1">ID Number</p>
          <p class="text-lg font-bold text-gray-900" id="popupIdNumber">-</p>
        </div>

        <div class="bg-blue-50 p-3 rounded-lg">
          <p class="text-xs text-gray-600 mb-1">Full Name</p>
          <p class="text-lg font-bold text-gray-900" id="popupStudentName">-</p>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="bg-blue-50 p-3 rounded-lg">
            <p class="text-xs text-gray-600 mb-1">Course</p>
            <p class="text-sm font-semibold text-gray-900" id="popupCourse">
              -
            </p>
          </div>

          <div class="bg-blue-50 p-3 rounded-lg">
            <p class="text-xs text-gray-600 mb-1">Year Level</p>
            <p class="text-sm font-semibold text-gray-900" id="popupLevel">-</p>
          </div>
        </div>

        <div class="bg-green-50 p-3 rounded-lg border-2 border-green-500">
          <p class="text-center text-green-700 font-bold text-lg">
            Attendance Recorded!
          </p>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="mt-4 w-full bg-gray-200 rounded-full h-2 overflow-hidden">
        <div
          id="progressBar"
          class="bg-blue-600 h-2 rounded-full transition-all duration-100"
          style="width: 100%"
        ></div>
      </div>
    </div>

    <!-- Overlay for popup -->
    <div
      id="popupOverlay"
      class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"
    ></div>

    <!-- Main Content Area -->
    <div class="content-wrapper">
      <div
        class="w-full max-w-md bg-white flex flex-col items-center border-2 border-gray-300 rounded-lg shadow-lg p-4 sm:p-6 gap-4"
      >
        <h2 class="text-xl sm:text-2xl font-bold text-gray-800">
          Scan QR Code for Attendance
        </h2>

        <!-- QR Reader Container -->
        <div id="reader" class="w-full"></div>

        <!-- Control Buttons -->
        <div class="w-full flex flex-col sm:flex-row gap-2">
          <button
            id="startBtn"
            class="flex-1 h-10 sm:h-11 text-sm sm:text-base text-white rounded-md bg-blue-600 hover:bg-blue-700 transition duration-300 font-medium shadow-md hover:shadow-lg"
          >
            START SCANNING
          </button>

          <button
            id="stopBtn"
            class="flex-1 h-10 sm:h-11 text-sm sm:text-base text-white rounded-md bg-red-600 hover:bg-red-700 transition duration-300 font-medium shadow-md hover:shadow-lg"
            disabled
          >
            STOP SCANNING
          </button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer
      class="w-full h-[10vh] min-h-[60px] flex justify-center items-center border-t-2 border-t-gray-200 fixed bottom-0 left-0 bg-white"
    >
      <p class="text-xs sm:text-sm md:text-base text-center">
        CopyRight &copy; DUPA & GUINITA
      </p>
    </footer>

    <!-- Load Html5Qrcode library -->
    <script src="https://unpkg.com/html5-qrcode"></script>

    <script>
      let html5QrCode = null;
      let isScanning = false;
      let popupTimeout = null;
      let progressInterval = null;

      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const studentPopup = document.getElementById("studentPopup");
      const popupOverlay = document.getElementById("popupOverlay");
      const closePopupBtn = document.getElementById("closePopup");
      const progressBar = document.getElementById("progressBar");

      async function saveAttendance(studentData) {
        // Get current date and time
        const now = new Date();
        const timeIn = now.toLocaleTimeString("en-US", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });
        const date = now.toLocaleDateString("en-US");

        // Fetch student list from backend to get the student's ID
        let studentId = null;
        try {
          const response = await fetch("/api/get_students");
          if (response.ok) {
            const students = await response.json();
            // Find the student by their ID number and get their position in the list
            const studentIndex = students.findIndex(
              (s) =>
                s.idno === studentData.idNumber ||
                s.idNumber === studentData.idNumber
            );
            if (studentIndex !== -1) {
              studentId = studentIndex + 1; // ID is the position (1-based index)
            }
          }
        } catch (error) {
          console.error("Error fetching student list:", error);
          alert("Unable to connect to student database. Please try again.");
          return false;
        }

        // If we couldn't find the student ID, don't proceed
        if (studentId === null) {
          alert("Student not found in database. Please contact administrator.");
          return false;
        }

        // Create attendance record with the database ID
        const attendanceRecord = {
          id: studentId, // This is the ID from the student management list
          idNumber: studentData.idNumber,
          name: `${studentData.firstName} ${studentData.lastName}`.trim(),
          course: studentData.course,
          level: studentData.level,
          timeIn: timeIn,
          date: date,
          timestamp: now.getTime(),
        };

        // Get existing attendance records
        let attendanceList =
          JSON.parse(localStorage.getItem("attendanceRecords")) || [];

        // Check if student already scanned today
        const alreadyScanned = attendanceList.some(
          (record) =>
            record.idNumber === studentData.idNumber && record.date === date
        );

        if (alreadyScanned) {
          alert("You have already recorded your attendance today!");
          return false;
        }

        // Add new record at the beginning
        attendanceList.unshift(attendanceRecord);

        // Save to localStorage
        localStorage.setItem(
          "attendanceRecords",
          JSON.stringify(attendanceList)
        );

        console.log("Attendance saved with ID:", studentId);
        return true;
      }

      // Show popup with student information
      function showStudentPopup(studentData) {
        // Populate popup with data
        document.getElementById("popupIdNumber").textContent =
          studentData.idNumber || "N/A";
        document.getElementById("popupStudentName").textContent =
          `${studentData.firstName || ""} ${
            studentData.lastName || ""
          }`.trim() || "N/A";
        document.getElementById("popupCourse").textContent =
          studentData.course || "N/A";

        const levelText = studentData.level
          ? `Year ${studentData.level}`
          : "N/A";
        document.getElementById("popupLevel").textContent = levelText;

        // Update student image if available
        const popupImage = document.getElementById("popupImage");
        if (studentData.image) {
          popupImage.src = studentData.image.startsWith("http")
            ? studentData.image
            : `../static/uploads/${studentData.image}`;
          popupImage.onerror = function () {
            this.src =
              "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
          };
        } else {
          popupImage.src =
            "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
        }

        // Show popup and overlay
        studentPopup.classList.remove("hidden");
        popupOverlay.classList.remove("hidden");

        studentPopup.classList.remove("popup-exit");
        studentPopup.classList.add("popup-enter");

        // Reset progress bar
        progressBar.style.width = "100%";

        // Animate progress bar
        let progress = 100;
        const totalTime = 3000;
        const intervalTime = 30;
        const decrement = (100 / totalTime) * intervalTime;

        clearInterval(progressInterval);
        progressInterval = setInterval(() => {
          progress -= decrement;
          if (progress <= 0) {
            progress = 0;
            clearInterval(progressInterval);
          }
          progressBar.style.width = progress + "%";
        }, intervalTime);

        // Auto-hide after 3 seconds
        clearTimeout(popupTimeout);
        popupTimeout = setTimeout(() => {
          hideStudentPopup();
        }, totalTime);
      }

      // Hide popup
      function hideStudentPopup() {
        studentPopup.classList.remove("popup-enter");
        studentPopup.classList.add("popup-exit");

        setTimeout(() => {
          studentPopup.classList.add("hidden");
          popupOverlay.classList.add("hidden");
        }, 400);

        clearTimeout(popupTimeout);
        clearInterval(progressInterval);
      }

      // Parse and display student data
      function displayStudentData(decodedText) {
        console.log("Raw QR Data:", decodedText);

        try {
          const studentData = JSON.parse(decodedText);
          console.log("Parsed Data:", studentData);

          const idNumber =
            studentData.idNumber ||
            studentData.idno ||
            studentData.IDNO ||
            studentData.id ||
            "";

          const firstName =
            studentData.firstName ||
            studentData.firstname ||
            studentData.FirstName ||
            "";

          const lastName =
            studentData.lastName ||
            studentData.lastname ||
            studentData.LastName ||
            "";

          const course = studentData.course || studentData.Course || "";
          const level = studentData.level || studentData.Level || "";
          const image = studentData.image || "";

          if (idNumber || firstName || lastName) {
            const normalizedData = {
              idNumber: idNumber || "N/A",
              firstName: firstName,
              lastName: lastName,
              course: course || "N/A",
              level: level || "N/A",
              image: image,
            };

            // Save attendance and show popup only if successful
            if (saveAttendance(normalizedData)) {
              showStudentPopup(normalizedData);
            }
          } else {
            alert(
              "Invalid QR code - All fields are empty!\n\n" +
                "Please ensure your QR code contains valid student data."
            );
          }
        } catch (error) {
          if (decodedText && decodedText.trim() !== "") {
            alert(
              "QR code format not recognized!\n\n" +
                "This appears to be an old format QR code.\n" +
                "Please regenerate the QR code from the student edit page.\n\n" +
                "ID detected: " +
                decodedText
            );
          } else {
            alert("Unable to read QR code data!");
          }
          console.error("QR Parse Error:", error);
        }
      }

      // Success callback
      function onScanSuccess(decodedText, decodedResult) {
        console.log(`QR Code detected: ${decodedText}`);
        displayStudentData(decodedText);
        stopScanning();
      }

      // Start scanning
      async function startScanning() {
        try {
          html5QrCode = new Html5Qrcode("reader");

          await html5QrCode.start(
            { facingMode: "environment" },
            {
              fps: 10,
              qrbox: { width: 250, height: 250 },
            },
            onScanSuccess
          );

          isScanning = true;
          startBtn.disabled = true;
          stopBtn.disabled = false;
          startBtn.classList.add("bg-gray-400", "cursor-not-allowed");
          startBtn.classList.remove("bg-blue-600", "hover:bg-blue-700");
        } catch (err) {
          alert(`Unable to start scanning: ${err}`);
        }
      }

      // Stop scanning
      async function stopScanning() {
        if (html5QrCode && isScanning) {
          try {
            await html5QrCode.stop();
            html5QrCode.clear();
            isScanning = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            startBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
            startBtn.classList.add("bg-blue-600", "hover:bg-blue-700");
          } catch (err) {
            console.error(`Error stopping scanner: ${err}`);
          }
        }
      }

      // Event listeners
      startBtn.addEventListener("click", startScanning);
      stopBtn.addEventListener("click", stopScanning);
      closePopupBtn.addEventListener("click", hideStudentPopup);
      popupOverlay.addEventListener("click", hideStudentPopup);

      window.addEventListener("beforeunload", () => {
        if (isScanning) {
          stopScanning();
        }
      });
    </script>
  </body>
</html>
